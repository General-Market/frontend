# General Market — Full Context

> Decentralized protocol for on-chain index products and prediction markets.

General Market enables users to create, trade, and manage tokenized Index Tracking Products (ITPs) and trade on Vision, a sealed parimutuel prediction market. The protocol runs on an Arbitrum Orbit L3 chain (Chain ID: 111222333). ITPs work like ETFs — each ITP holds a fixed basket of crypto assets whose NAV floats with underlying prices. Vision lets traders bet on binary price outcomes (UP/DOWN) across batches of assets with configurable tick durations.

Website: https://generalmarket.io
Discord: https://discord.gg/xsfgzwR6

---

## What is an ITP?

An Index Tracking Product (ITP) is a tokenized basket of crypto assets — the on-chain equivalent of an ETF. Each ITP has:

- **Fixed per-share quantities** of each underlying asset (set at creation or rebalance)
- **A floating NAV** computed as: `NAV = sum(qty[i] * price[i]) / 1e18`
- **ERC-4626 vault tokens** that represent shares in the basket

### ITP Pricing Model

At creation, weights are converted to fixed per-share quantities:
```
ITP starts at $1 (1e18).
qty[i] = (weight[i] * 1e18) / price[i]
```

Example: 100 assets, equal weight (1% each), all at $1 → each qty = 0.01 tokens per share.

NAV computation (used everywhere):
```
NAV = sum(qty[i] * price[i]) / 1e18
```

Key invariants:
- Quantities are stored on-chain and ONLY change on rebalance
- Buy/sell do NOT change quantities — buy and sell operations mint/burn proportional shares
- Rebalance recalculates: `qty_new[i] = (w_new[i] * currentNAV) / price[i]` — preserves NAV
- NAV drifts from $1 over time as prices change (this is the intended behavior)

### Creating an ITP

Users select assets and assign percentage weights (must sum to 100%). The smart contract converts weights to fixed per-share quantities using current prices. Minimum 1 asset, maximum 100 assets per ITP. ITP deployers can set metadata (name, description, website, video URL) and claim deployer fees.

---

## Order Lifecycle

### Buy Flow (10 steps)
1. User approves USDC spend on L3
2. User calls `submitOrder(itpId, amount, BUY)` — USDC is escrowed
3. The order enters PENDING status on-chain
4. Issuer nodes collect pending orders in COLLECT phase (200ms)
5. The leader issuer proposes a batch in PROPOSE phase (200ms)
6. Peer issuer nodes validate and BLS-sign the batch hash
7. The leader aggregates signatures (threshold: ceil(2n/3))
8. `confirmBatch()` is submitted on-chain with aggregated BLS signature → BATCHED
9. The Authorized Participant (AP) receives the TradeRequest event and executes trades on Bitget exchange
10. The AP reports fills via `confirmFills()` → ITP shares are minted to the user's wallet

### Sell Flow
Same lifecycle in reverse — the user submits a sell order, ITP shares are burned, and USDC is returned after the AP executes the underlying trades.

### Timing
- Cycle duration: 1 second (5 phases × 200ms each)
- Order timeout: 60 seconds with 3 retries
- Price tolerance: 0.1% per fill

---

## Lending (Morpho Integration)

General Market integrates with Morpho lending markets for two operations:

### Deposit USDC to Earn Yield
- Deposit USDC into the Morpho vault
- Earn yield from borrowers
- Withdraw USDC anytime

### Borrow USDC Against ITP Shares
- Use ITP shares as collateral
- Borrow USDC against the ITP position
- Manage health factor to avoid liquidation

Available for ITPs that have Morpho lending markets configured.

---

## Backtesting

Simulate portfolio performance before deploying real capital:

- Select assets and weights
- Choose historical time period
- Run simulation with real historical price data
- View returns, drawdowns, Sharpe ratio
- Deploy winning strategies as real ITPs directly from results

Backtesting uses the data node's `/sim/run` (batch) or `/sim/run-stream` (SSE streaming) endpoints.

---

## Vision (Prediction Market)

Vision is a sealed parimutuel prediction market on the General Market L3 chain. Traders bet on whether asset prices move UP or DOWN over fixed time intervals called ticks. All bets within a tick share a common pool — winners split the losers' stakes, minus a 0.3% protocol fee on profits.

The internal technical name is "P2Pool" (used in contract code and API endpoints).

### Batches

A batch is a group of markets with a shared pool, tick duration, and resolution configuration. Any user can create a batch by selecting:

- **Markets** — 1 to 100+ assets (e.g., BTC, ETH, SOL, weather data, sports outcomes)
- **Tick duration** — time between resolutions: 5min, 10min, 30min, 1h, 4h, or 1 day
- **Resolution types** — how each market determines winners (UP_0, UP_30, UP_X, DOWN_0, DOWN_30, DOWN_X, FLAT_0, FLAT_X)

Once created, a batch runs continuously. New players can join at any time.

### Bitmaps (Sealed Binary Bets)

A bitmap is a packed binary representation of a player's bets across all markets in a batch:

- 1 bit per market: 1 = UP, 0 = DOWN
- Big-endian bit ordering (bit 0 = MSB of byte 0)
- Total size: ceil(marketCount / 8) bytes

Bitmaps follow a commit-reveal scheme:
1. **Commit** — the player submits `keccak256(bitmap)` on-chain when joining the batch
2. **Reveal** — the player sends the actual bitmap bytes to issuer nodes via `POST /p2pool/bitmap`

The sealed commitment prevents front-running: other players cannot see bet directions until after the commitment deadline.

### Ticks and Resolution

At the end of each tick:
1. Issuer nodes fetch closing prices for all markets
2. Each market resolves to a binary outcome based on price movement and the configured resolution type
3. Each player's bitmap is compared against actual outcomes
4. The tick pool (sum of all players' stakePerTick) is distributed to winners proportionally
5. Losers forfeit their stakePerTick for that tick

### Resolution Types

| Type | Threshold | UP Wins When |
|------|-----------|--------------|
| UP_0 | 0% | Price increases by any amount |
| UP_30 | 0.30% | Price increases by ≥30 basis points |
| UP_X | Custom | Price increases by ≥X basis points |
| DOWN_0 | 0% | Price decreases by any amount |
| DOWN_30 | 0.30% | Price decreases by ≥30 basis points |
| DOWN_X | Custom | Price decreases by ≥X basis points |
| FLAT_0 | 0% | Price does not change |
| FLAT_X | Custom | Price stays within X basis points of open |

### Balance Proofs and BLS Verification

Player balances are tracked off-chain by issuer nodes and verified on-chain via BLS signatures. To claim rewards or withdraw:
1. Player requests a BLS-signed balance proof from the issuer network
2. Issuer nodes compute the player's balance (deposits + winnings - losses - fees)
3. Issuers produce a BLS-signed message containing the balance
4. Player submits the balance and BLS signature to the Vision contract
5. The contract verifies the BLS signature and updates the player's on-chain balance

### Fee Structure

Vision charges 0.3% (30 basis points) on profits only. Players who lose a tick pay no fee.

```
fee = (winnings * 30) / 10000
payout = winnings - fee
```

### Vision Smart Contract Functions

| Function | Description |
|----------|-------------|
| `createBatch(marketIds, resolutionTypes, tickDuration, customThresholds)` | Create a new batch |
| `joinBatch(batchId, depositAmount, stakePerTick, bitmapHash)` | Join a batch with USDC deposit and sealed bitmap commitment |
| `updateBitmap(batchId, newBitmapHash)` | Update bet commitment |
| `deposit(batchId, amount)` | Add USDC to existing position |
| `claimRewards(batchId, fromTick, toTick, newBalance, blsSignature)` | Claim winnings for tick range |
| `withdraw(batchId, finalBalance, blsSignature)` | Exit batch with BLS-signed final balance |
| `registerBot(endpoint, pubkeyHash)` | Register automated trading bot (free, no collateral) |
| `deregisterBot()` | Remove bot registration |
| `getAllActiveBots()` | List all registered bots |

### Vision API Endpoints

**P2Pool API** (served by issuer nodes):
- `GET /p2pool/batches` — all active batches (id, markets, tick duration, player count, TVL)
- `GET /p2pool/batch/{batchId}/state` — batch state with player positions
- `GET /p2pool/batch/{batchId}/history` — tick resolution history (outcomes, pool size, winners/losers)
- `POST /p2pool/bitmap` — submit sealed bitmap to issuer node (player, batch_id, bitmap_hex, expected_hash)
- `GET /p2pool/balance/{batchId}/{player}` — BLS-signed balance proof (optional: ?fromTick=N&toTick=M for claim range)

**Data Node API** (market data):
- `GET /p2pool/markets/active` — available markets for batch creation (id, source, name, value, change24h)

### Building a Vision Bot

The protocol supports automated trading bots. Reference implementation: `vision-bot/bot.py`.

Bot lifecycle:
1. Register via `registerBot(endpoint, pubkeyHash)` — free, no collateral
2. Poll `GET /p2pool/batches` for active batches
3. For each batch: generate bets → encode bitmap → compute keccak256 hash → approve USDC → call `joinBatch()` → POST bitmap to all issuer nodes
4. Periodically claim rewards via BLS balance proofs

Bitmap encoding (Python):
```python
def encode_bitmap(bets: list[str], market_count: int) -> bytes:
    byte_count = (market_count + 7) // 8
    bitmap = bytearray(byte_count)
    for i in range(market_count):
        if i < len(bets) and bets[i] == "UP":
            byte_idx = i // 8
            bit_idx = 7 - (i % 8)  # big-endian
            bitmap[byte_idx] |= 1 << bit_idx
    return bytes(bitmap)
```

---

## Architecture

### Blockchain Layer
- **Chain**: Arbitrum Orbit L3 (Chain ID: 111222333)
- **RPC**: https://index.rpc.zeeve.net
- **Collateral**: USDC (WUSDC on L3, 18 decimals)

### Smart Contracts — ITP
| Contract | Purpose |
|----------|---------|
| Index.sol | Order submission, batch/fill confirmation, ITP management |
| ITP.sol | ERC-4626 vault for ITP share tokens |
| BridgeProxy.sol | Cross-chain bridging between Arbitrum and L3 |
| BridgedItpFactory.sol | Factory for creating bridged ITP tokens |
| Governance.sol | Admin controls, pause functionality |
| BLSCustody.sol | BLS-gated custody operations |

### Smart Contracts — Vision
| Contract | Purpose |
|----------|---------|
| Vision.sol | Sealed parimutuel prediction market (batches, bitmaps, ticks, claims, withdrawals) |
| BotRegistry (in Vision.sol) | On-chain bot registration (endpoint, pubkey hash) |

### Smart Contracts — Registries
| Contract | Purpose |
|----------|---------|
| IssuerRegistry.sol | Issuer BLS keys, aggregated pubkey, key rotation |
| CollateralRegistry.sol | Whitelisted collateral tokens |
| AssetPairRegistry.sol | Trading pairs configuration |
| FeeRegistry.sol | Fee tiers and deployer fee claiming |

### Smart Contracts — Libraries
| Library | Purpose |
|---------|---------|
| BLSLib.sol | BLS verification using EVM precompiles (BN254) |
| TypesLib.sol | Shared struct definitions |
| ErrorsLib.sol | Custom error definitions (E001–E069+) |
| EventsLib.sol | Event definitions |

### Issuer Nodes (Consensus Layer)
3+ issuer nodes run BLS consensus:
- **BLS Curve**: BN254 (EVM precompile compatible)
- **Threshold**: ceil(2n/3) signatures required
- **Message Format**: keccak256(chainId, contractAddress, cycleNumber, orderIds)
- **P2P Transport**: TCP with TLS, static + on-chain peer discovery
- **Leader Election**: Round-robin per cycle

Issuer nodes also handle Vision tick resolution, bitmap verification, and BLS balance proof generation.

### Authorized Participant (AP)
Executes ITP trades on centralized exchanges (Bitget):
- Monitors chain for TradeRequest events
- Places orders with 0.1% price tolerance
- Reports fills back on-chain
- 60-second timeout with 3 retries
- Buffer management for partial fills

### Data Node
Backend service providing market data and analytics:
- Real-time price feeds for 100+ crypto assets
- NAV computation for all ITPs
- Historical price data for backtesting
- Portfolio tracking and P&L
- Vision market data (active markets for batch creation)
- REST API on port 8200

---

## Data Node API Reference

Base URL: `https://generalmarket.io/api` (proxied to data node)

### Price Endpoints
- `GET /price?asset=BTC` — single asset latest price
- `GET /prices` — all latest prices
- `GET /latest-prices` — optimized bulk price fetch
- `GET /fast-prices` — low-latency prices for trading

### ITP Endpoints
- `GET /itp-price?itp_id=0x...` — ITP NAV, inventory, asset breakdown
- `GET /nav-series?itp_id=0x...&range=7d` — historical NAV time series
- `GET /aum-ranking` — all ITPs ranked by AUM
- `GET /snapshot` — current state snapshot of all ITPs

### Portfolio Endpoints
- `GET /portfolio?address=0x...` — user portfolio summary
- `GET /portfolio/history?address=0x...` — portfolio value history
- `GET /portfolio/trades?address=0x...` — trade history

### Simulation Endpoints
- `POST /sim/run` — run backtest simulation (batch, returns JSON)
- `POST /sim/run-stream` — run backtest with SSE streaming progress
- `GET /sim/categories` — available asset categories for simulation

### Morpho (Lending) Endpoints
- `GET /morpho-position?address=0x...` — user lending position
- `GET /morpho-history?address=0x...` — lending history

### Vision Market Endpoints
- `GET /p2pool/markets/active` — available markets for Vision batch creation

---

## Security Model

- **BLS Verification**: Never bypassed — all batch confirmations and Vision balance proofs require valid aggregated BLS signatures
- **Issuer Isolation**: Issuer nodes cannot communicate directly with the AP — issuer nodes read on-chain data only
- **Price Tolerance**: 0.1% maximum deviation per fill
- **Order Timeout**: 60 seconds with automatic retry (up to 3 attempts)
- **Escrow**: USDC is locked on-chain during the ITP order lifecycle
- **Sealed Commitments**: Vision bitmap hashes are committed on-chain before reveal, preventing front-running

---

## Technology Stack

| Category | Technology |
|----------|-----------|
| Smart Contracts | Solidity (Foundry), OpenZeppelin 5.x, UUPS Proxy |
| Backend | Rust (Tokio async runtime), ethers-rs |
| Cryptography | ark-bn254 (BLS on BN254 curve) |
| Frontend | Next.js 15, React 19, wagmi, viem, TailwindCSS |
| Exchange | Bitget API (HMAC auth, rate limited) |
| Lending | Morpho Protocol |
| Hosting | Vercel (frontend), Contabo/Hetzner VPS (backend) |

---

## Glossary

- **ITP**: Index Tracking Product — tokenized basket of crypto assets (like an ETF)
- **NAV**: Net Asset Value — total value of underlying assets per share
- **BLS**: Boneh-Lynn-Shacham signature scheme — enables signature aggregation for consensus
- **AP**: Authorized Participant — entity that executes trades on exchanges for the protocol
- **Issuer**: Consensus node that batches orders and produces BLS signatures
- **L3**: Layer 3 — Arbitrum Orbit chain where the protocol operates
- **Morpho**: DeFi lending protocol integrated for ITP collateral lending
- **Rebalance**: Updating ITP asset quantities to match new target weights while preserving NAV
- **USDC**: USD Coin — the collateral token used for all trading (18 decimals on L3)
- **Vision**: Sealed parimutuel prediction market for binary price bets (internal name: P2Pool)
- **Batch**: A group of Vision markets with shared pool, tick duration, and resolution configuration
- **Bitmap**: Packed binary representation of a player's UP/DOWN bets (1 bit per market, big-endian)
- **Tick**: One resolution interval within a Vision batch (5min to 1 day)
- **Resolution Type**: Threshold configuration for Vision market outcomes (UP_0, UP_30, UP_X, DOWN_0, DOWN_30, DOWN_X, FLAT_0, FLAT_X)
- **Sealed Commitment**: keccak256 hash of a bitmap, committed on-chain before reveal to prevent front-running
- **Balance Proof**: BLS-signed message from issuer nodes attesting to a player's Vision batch balance
- **Bot Registry**: On-chain registry for automated Vision trading bots (free registration, no collateral)
